---

#### Defensive Programming
# https://github.com/openshift/openshift-ansible/blob/master/docs/best_practices_guide.adoc

- name: Fail for Missing Transfer Method
  fail: msg="This role requires transfer_method to be set and non empty. See the README"
  when: transfer_method is not defined or transfer_method == ''
  tags:
    - jboss_eap

- name: Fail for Missing Red Hat Network Username
  fail: msg="This role requires rhn_username to be set and non empty."
  when: transfer_method == 'csp-to-host' and (rhn_username is not defined or rhn_username == '')
  tags:
    - jboss_eap

- name: Fail for Missing Red Hat Network Password
  fail: msg="This role requires rhn_password to be set and non empty."
  when: transfer_method == 'csp-to-host' and (rhn_password is not defined or rhn_password == '')
  tags:
    - jboss_eap

#### Set Facts
- name: Set JBoss EAP Download Facts
  set_fact:
    jboss_eap_artifact_url: "{{ jboss_eap_artifact_source }}"
    jboss_eap_artifact_dl_dest: "{{ '/tmp/' + jboss_eap_artifact_name }}"
    jboss_eap_library_dest: "/opt/{{ jboss_eap_user }}"
    jboss_eap_patch_artifact_url: "{{ jboss_eap_patch_artifact_source }}"
    jboss_eap_patch_dest: "/tmp/{{ jboss_eap_patch_artifact_name }}"
    jboss_eap_facted_port_offset: "{{jboss_eap_port_offset * 100 }}"
  tags:
    - jboss_eap

- name: Set JBoss EAP Group Facts
  set_fact:
    jboss_eap_group: "{{ jboss_eap_user }}"
  tags:
    - jboss_eap

- name: Set JBoss EAP Service Directories Facts
  set_fact:
    jboss_eap_home: "{{ jboss_eap_library_dest }}/jboss-eap-6.4"
    jboss_eap_service_conf_dir: "/etc/{{ jboss_eap_user }}"
    jboss_eap_service_log_dir: "/var/log/{{ jboss_eap_user }}"
    jboss_eap_service_data_dir: "/var/run/{{ jboss_eap_user }}"
  tags:
    - jboss_eap

- name: Set JBoss EAP Service Files Facts
  set_fact:
    jboss_eap_service_conf_file: "{{ jboss_eap_service_conf_dir }}/{{ jboss_eap_user }}.conf"
    jboss_eap_standalone_service_file: "/etc/systemd/system/{{ jboss_eap_user }}-standalone.service"
  tags:
    - jboss_eap

#### Create Service Account

- include: jboss_service.yml

#### Defensive Programming To Check If EAP Is Already Installed

- name: Check Existence of Libraries
  sudo: true
  stat:
    path: "{{ jboss_eap_library_dest + '/jboss-eap-6.4/version.txt'}}"
  register: jboss_eap_exists
  tags:
    - jboss_eap

# Currently we only support patching from base (e.g. 6.x.0), not incremental minor release patches as the role is for initial install
- name: Determine if the Patch Can Be Applied
  become: yes
  become_user: "{{ jboss_eap_user }}"
  command: "{{ jboss_eap_home }}/bin/jboss-cli.sh 'patch info --verbose'"
  register: patch_info_result
  tags:
    - jboss_eap
    - dev
  when: jboss_eap_apply_patch == true and jboss_eap_exists.stat.exists == true

#### Download and install base library and patch

- name: Async Download JBoss EAP Patch from Red Hat Customer Portal
  redhat_csp_download:
    url: "{{ jboss_eap_patch_artifact_url }}"
    dest: "{{ jboss_eap_patch_dest }}"
    username: "{{ rhn_username }}"
    password: "{{ rhn_password }}"
  async: 7200
  poll: 0
  register: jboss_eap_patch_download
  tags:
    - jboss_eap
  when: transfer_method == 'csp-to-host' and jboss_eap_apply_patch == true and (jboss_eap_exists.stat.exists == false or 'base' in patch_info_result.stdout)

- name: Async Download JBoss EAP from Red Hat Customer Portal
  redhat_csp_download:
    url: "{{ jboss_eap_artifact_url }}"
    dest: "{{ jboss_eap_artifact_dl_dest }}"
    username: "{{ rhn_username }}"
    password: "{{ rhn_password }}"
  async: 7200
  poll: 0
  register: jboss_eap_download
  tags:
    - jboss_eap
  when: transfer_method == 'csp-to-host' and jboss_eap_exists.stat.exists == false

- name: 'Check On JBoss EAP Download Completion'
  async_status: jid={{ jboss_eap_download.ansible_job_id }}
  register: job_result1
  until: job_result1.finished
  retries: 600
  delay: 10
  tags:
    - jboss_eap
  when: transfer_method == 'csp-to-host' and jboss_eap_exists.stat.exists == false

- name: 'Check On JBoss EAP Patch Download Completion'
  async_status: jid={{ jboss_eap_patch_download.ansible_job_id }}
  register: job_result2
  until: job_result2.finished
  retries: 600
  delay: 10
  tags:
    - jboss_eap
  when: transfer_method == 'csp-to-host' and jboss_eap_apply_patch == true and (jboss_eap_exists.stat.exists == false or 'base' in patch_info_result.stdout)

- name: Copy JBoss EAP
  copy:
    src: "{{ jboss_eap_artifact_url }}"
    dest: "{{ jboss_eap_artifact_dl_dest }}"
  tags:
    - jboss_eap
  when: transfer_method == 'copy-from-controller' and jboss_eap_exists.stat.exists == false

- name: Copy JBoss EAP Patch
  copy:
    src: "{{ jboss_eap_patch_artifact_name }}"
    dest: "{{ jboss_eap_patch_dest }}"
  tags:
    - jboss_eap
  when: transfer_method == 'copy-from-controller' and jboss_eap_apply_patch == true and (jboss_eap_exists.stat.exists == false or 'base' in patch_info_result.stdout)

- name: Extract JBoss EAP Libraries
  sudo: true
  unarchive:
    src: "{{ jboss_eap_artifact_dl_dest }}"
    dest: "{{ jboss_eap_library_dest }}"
    creates: jboss-eap-6.4
    copy: no
    owner: "{{ jboss_eap_user }}"
    group: "{{ jboss_eap_group }}"
  notify: Enable jboss-as Service
  tags:
    - jboss_eap
  when: jboss_eap_exists.stat.exists == false

# Patches can be applied while EAP is running
- name: Apply JBoss EAP Patch
  become: yes
  become_user: "{{ jboss_eap_user }}"
  command: "{{ jboss_eap_home }}/bin/jboss-cli.sh 'patch apply {{ jboss_eap_patch_dest }} --verbose'"
  notify: Restart and Enable jboss-as Service
  tags:
    - jboss_eap
    - dev
  when: jboss_eap_apply_patch == true and (jboss_eap_exists.stat.exists == false or 'base' in patch_info_result.stdout)

# Copy the init.d scripts, this is done here to ensure that we overwrite the 
# file from the JBoss EAP post unarchive
- name: "Copy EAP service init.d scripts"
  template: 
    src: "jboss-as-{{jboss_eap_config}}.sh.j2"
    dest: "{{jboss_eap_home}}/bin/init.d/jboss-as-{{jboss_eap_config}}.sh"
    owner: "{{ jboss_eap_user }}"
    group: "{{ jboss_eap_group }}"
    mode: "755"
    backup: yes
  notify: Restart jboss-as Service
  tags:
    - jboss_eap

#### Set Sensible Defaults For Runtime

- name: Set User Time Zone for Logs
  lineinfile:
    dest: "{{ jboss_eap_runtime_conf_file }}"
    line: "JAVA_OPTS=\"$JAVA_OPTS -Duser.timezone={{jboss_eap_logging_timezone}}\""
  tags:
    - jboss_eap
